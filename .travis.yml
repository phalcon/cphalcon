language: php

dist: trusty
sudo: false

php:
  - 5.5
  - 5.6
  - 7.0
  - 7.1
  - 7.2
  - nightly

matrix:
  fast_finish: true
  allow_failures:
    - php: nightly

git:
  depth: 1

cache:
  apt: true
  ccache: true
  timeout: 604800
  directories:
    - .temp
    - $HOME/beanstalk
    - $HOME/.ccache
    - $HOME/.composer/cache
    - $HOME/pear
    - $HOME/.local/opt/re2c
    - $HOME/.cache/re2c

services:
  - beanstalkd
  - mongodb
  - redis-server
  - postgresql

env:
  global:
    - TEST_BT_HOST="127.0.0.1"
    - TEST_BT_PORT="11300"
    - TEST_MC_HOST="127.0.0.1"
    - TEST_MC_PORT="11211"
    - TEST_MC_WEIGHT="1"
    - TEST_DB_SQLITE_NAME="/tmp/phalcon_test.sqlite"
    - TEST_DB_MYSQL_HOST="127.0.0.1"
    - TEST_DB_MYSQL_PORT="3306"
    - TEST_DB_MYSQL_USER="root"
    - TEST_DB_MYSQL_PASSWD=""
    - TEST_DB_MYSQL_NAME="phalcon_test"
    - TEST_DB_MYSQL_CHARSET="utf8"
    - TEST_DB_POSTGRESQL_HOST="127.0.0.1"
    - TEST_DB_POSTGRESQL_PORT="5432"
    - TEST_DB_POSTGRESQL_USER="postgres"
    - TEST_DB_POSTGRESQL_PASSWD=""
    - TEST_DB_POSTGRESQL_NAME="phalcon_test"
    - TEST_DB_MYSQL_DSN="mysql:host=127.0.0.1;dbname=phalcon_test"
    - TEST_DB_MONGO_HOST="127.0.0.1"
    - TEST_DB_MONGO_PORT="27017"
    - TEST_DB_MONGO_USER="admin"
    - TEST_DB_MONGO_PASSWD=""
    - TEST_DB_MONGO_NAME="phalcon_test"
    - TEST_RS_HOST="127.0.0.1"
    - TEST_RS_PORT="6379"
    - TEST_RS_DB="0"
    - TEST_CACHE_DIR="tests/_cache/"
    - CC="ccache gcc"
    - PATH="$PATH:$HOME/bin"
    - BEANSTALKD_VERSION="1.10"
    - ZEPHIR_PARSER_VERSION="v1.1.1"
    - RE2C_VERSION="1.0.3"
    # Uncomment for debug
    #- ZEND_DONT_UNLOAD_MODULES=1

before_install:
  - if [[ ! -z "${GH_TOKEN}" ]]; then composer config github-oauth.github.com ${GH_TOKEN}; echo "Configured Github token"; fi;
  - export PHP_MAJOR="$(echo $TRAVIS_PHP_VERSION | cut -d '.' -f 1)"
  - export PHP_MINOR="$(echo $TRAVIS_PHP_VERSION | cut -d '.' -f 2)"
  - bash tests/_ci/pear_setup.sh
  - bash tests/_ci/setup_dbs.sh

install:
  - composer install -q -n --no-ansi --no-progress --dev --prefer-source --no-suggest --ignore-platform-reqs
  - |
      if [ "${PHP_MAJOR}.${PHP_MINOR}" = "7.2" ]; then
          composer remove -q -n --no-ansi --no-progress --dev doctrine/instantiator
          composer remove -q -n --no-ansi --no-progress --dev phpdocumentor/reflection-docblock
          composer remove -q -n --no-ansi --no-progress --dev phpunit/phpunit
          composer require -q -n --no-ansi --no-progress --dev --prefer-source --no-suggest  phpunit/phpunit:^6.4
      fi
  - bash tests/_ci/install_prereqs_$PHP_MAJOR.sh
  - bash tests/_ci/install-re2c $RE2C_VERSION
  - bash tests/_ci/install_zephir_parser.sh
  - bash tests/_ci/install_zephir.sh
  - zephir generate
  # Use `-g -O0' for debug purposes
  - export CFLAGS="-g3 -O1 -std=gnu90 -Wall"
  - cd ${TRAVIS_BUILD_DIR}/ext
  # Creating precompiled headers.
  # If a `*.gch' file is not found then the normal header files will be used.
  # For more see: http://en.wikipedia.org/wiki/Precompiled_header
  - |
      for file in `find kernel -name "*.h"`; do
          echo -e "Creating a precompiled header from $file ...";
          $CC "$file" -I. $(php-config --includes) -o "$file.ghc";
      done
  # You may need to remove all `&> /dev/null' and `--silent' for debug purposes
  - $(phpenv which phpize) &> /dev/null
  - ./configure --silent --with-php-config=$(phpenv which php-config) --enable-phalcon &> /dev/null
  - make --silent -j"$(getconf _NPROCESSORS_ONLN)" &> /dev/null
  - make --silent install
  - phpenv config-add $TRAVIS_BUILD_DIR/tests/_ci/phalcon.ini
  # Here is common php config
  - phpenv config-add $TRAVIS_BUILD_DIR/tests/_ci/ci.ini
  # Some debug info located here
  - ls -al `$(phpenv which php-config) --extension-dir`
  - $(phpenv which php) -v
  - $(phpenv which php) -m
  - $(phpenv which php) --ri phalcon

before_script:
  # Uncomment for debug
  # - ulimit -c unlimited -S || true
  # - echo '/tmp/core_%e.%p' | sudo tee /proc/sys/kernel/core_pattern &> /dev/null
  # attempt to workaroung "ptrace: Operation not permitted"
  # - sudo chmod +s $(which gdb)

script:
  - cd $TRAVIS_BUILD_DIR
  # Syntax recognize tests
  - |
      $(phpenv which php) $TRAVIS_BUILD_DIR/ext/run-tests.php \
          -p $(phpenv which php) \
          -g "FAIL,XFAIL,BORK,WARN,LEAK,SKIP" \
          --offline \
          --show-diff \
          --set-timeout 120

  - vendor/bin/phpcs
  - |
      if [ "${PHP_MAJOR}.${PHP_MINOR}" != "7.2" ]; then
          vendor/bin/phpunit --bootstrap tests/_ci/phpunit.php --debug unit-tests/
      fi
  - vendor/bin/codecept build
  - vendor/bin/codecept run -v -n tests/integration/
  - vendor/bin/codecept run -v -n tests/unit/
  # Legacy tests. Only PHP 5
  - phpenv config-rm xdebug.ini
  - if [[ "$PHP_MAJOR" == 5 ]]; then vendor/bin/codecept run -v -n tests/unit5x/; fi;

# Uncomment for debug
# after_failure:
#  - bash tests/_ci/after_failure.sh

notifications:
    email:
        on_success: never
        on_failure: never

addons:
    apt:
        packages:
            - beanstalkd
            # Uncomment for debug
            # - gdb
